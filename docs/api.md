# Документация по PKeyDB

## Введение

**PKeyDB** — легковесная сетевая СУБД (ключ-значение) с REST API, авторизацией, хранением данных на диске, конфигурируемостью через INI-файл, логированием в stdout/stderr, поддержкой нескольких БД с паролями и лимитами. Предназначена для быстрого хранения и доступа к данным по ключу через HTTP.

---

## Архитектура и компоненты

- **main.pas** — точка входа, обработка параметров, запуск сервера
- **config.pas** — парсер INI-файла, хранение параметров
- **server.pas** — HTTP-сервер, обработка REST API
- **auth.pas** — авторизация, работа с токенами
- **storage.pas** — файловое хранилище, операции с БД
- **test_config.pas** — тесты загрузки конфига
- **Логирование** — stdout (инфо), stderr (ошибки)

---

## Конфигурация

Конфигурационный файл в формате INI. Пример:

```
[server]
address=0.0.0.0
port=8080
jwt_secret=supersecretkey
jwt_expiry=60

[databases]
db1.path=data/db1.db
db1.password=5b11618c2e44027877d0cd0921ed166b9f176f50587fc91e7534dd2946db77d6  # SHA256("secret1")
db1.limit=10485760
db1.limit_action=rotate
db2.path=data/db2.db
db2.password=... # SHA256("secret2")
db2.limit=none
db2.limit_action=error
```

- **[server]** — параметры сервера (address, port, jwt_secret, jwt_expiry)
- **[databases]** — список БД, для каждой: путь, пароль (**SHA256-хэш!**), лимит (в байтах или none), действие при превышении лимита
- **ВАЖНО:** Пароль в конфиге — это **SHA256-хэш** строки-пароля в hex (нижний регистр, без пробелов). Не указывайте plain-текст!

### Как получить SHA256-хэш пароля

В Linux/macOS:
```
echo -n "yourpassword" | sha256sum
```
В Windows (PowerShell):
```
echo -n "yourpassword" | openssl dgst -sha256
```

Вставьте полученный hex-хэш в конфиг как значение `dbN.password`.

---

## Формат хранения данных

Для каждой БД создаются два файла:
- `{dbname}.idx` — индексный файл (хеш-таблица: хеш ключа, смещение, размер, флаг удаления)
- `{dbname}.dat` — файл данных (значения, каждое с размером и флагом валидности)

Индекс загружается в память для быстрого доступа. Все изменения сразу пишутся на диск.

---

## REST API

### Общие принципы
- Все ответы — JSON
- Для операций с БД требуется авторизация (токен в заголовке)
- Коды ошибок соответствуют HTTP-стандарту

### Эндпоинты

| Метод | Путь                       | Описание                  |
|-------|----------------------------|---------------------------|
| POST  | /auth                      | Авторизация, токен        |
| POST  | /db/{dbname}/set           | Создать/обновить ключ     |
| GET   | /db/{dbname}/get?key=...   | Получить значение         |
| DELETE| /db/{dbname}/del?key=...   | Удалить ключ              |
| GET   | /db/{dbname}/list          | Список ключей (опционально)|
| POST  | /db/{dbname}/clear         | Полная очистка базы       |

---

### Авторизация

**POST /auth**

- Тело запроса (JSON):
  ```json
  { "dbname": "db1", "password": "plain_or_hash" }
  ```
- Ответ (успех):
  ```json
  { "token": "<jwt>" }
  ```
- Ответ (ошибка):
  ```json
  { "error": "Invalid credentials" }
  ```
- Пример curl:
  ```bash
  curl -X POST http://localhost:8080/auth -H 'Content-Type: application/json' -d '{"dbname":"db1","password":"mypassword"}'
  ```

**Использование токена:**
- Для всех операций с БД добавляйте заголовок:
  X-Auth-Token: <jwt>

> **Безопасность:** Токен — это JWT (HS256, claim sub=имя БД, exp=60 минут, iss=PKeyDB, jti). Секрет для подписи хранится в конфиге (jwt_secret). После истечения срока действия требуется повторная авторизация. Токен даёт полный доступ только к одной БД (sub).

---

### Операции с БД

#### 1. Создать/обновить ключ
**POST /db/{dbname}/set**
- Заголовок: X-Auth-Token: <jwt>
- Тело запроса (JSON):
  ```json
  { "key": "mykey", "value": "myvalue" }
  ```
- Ответ (успех):
  ```json
  { "result": "ok" }
  ```
- Ответ (ошибка):
  ```json
  { "error": "Limit exceeded" }
  ```
  (если limit_action=error)
- Ответ (при ротации, limit_action=rotate):
  ```json
  { "result": "ok" }
  ```
  (база автоматически очищена, запись выполнена)
- Пример curl:
  ```bash
  curl -X POST http://localhost:8080/db/db1/set -H 'X-Auth-Token: <jwt>' -H 'Content-Type: application/json' -d '{"key":"foo","value":"bar"}'
  ```

#### 2. Получить значение по ключу
**GET /db/{dbname}/get?key=...**
- Заголовок: X-Auth-Token: <jwt>
- Ответ (успех):
  ```json
  { "key": "foo", "value": "bar" }
  ```
- Ответ (ошибка):
  ```json
  { "error": "Not found" }
  ```
- Пример curl:
  ```bash
  curl -X GET 'http://localhost:8080/db/db1/get?key=foo' -H 'X-Auth-Token: <jwt>'
  ```

#### 3. Удалить ключ
**DELETE /db/{dbname}/del?key=...**
- Заголовок: X-Auth-Token: <jwt>
- Ответ (успех):
  ```json
  { "result": "deleted" }
  ```
- Ответ (ошибка):
  ```json
  { "error": "Not found" }
  ```
- Пример curl:
  ```bash
  curl -X DELETE 'http://localhost:8080/db/db1/del?key=foo' -H 'X-Auth-Token: <jwt>'
  ```

#### 4. Список ключей (опционально)
**GET /db/{dbname}/list**
- Заголовок: X-Auth-Token: <jwt>
- Ответ (успех):
  ```json
  { "keys": ["foo", "bar", ...] }
  ```
- Пример curl:
  ```bash
  curl -X GET 'http://localhost:8080/db/db1/list' -H 'X-Auth-Token: <jwt>'
  ```

#### 5. Полная очистка базы
**POST /db/{dbname}/clear**
- Заголовок: X-Auth-Token: <jwt>
- Ответ (успех):
  ```json
  { "result": "cleared" }
  ```
- Ответ (ошибка):
  ```json
  { "error": "Internal error" }
  ```
- Ответ (ошибка, несуществующая база):
  ```json
  { "error": "Not found" }
  ```
- Пример curl:
  ```bash
  curl -X POST http://localhost:8080/db/db1/clear -H 'X-Auth-Token: <jwt>'
  ```

> **Внимание!** Операция очистки базы необратима: все данные будут удалены без возможности восстановления.

---

## Коды ошибок и ответы

| Код | Описание                | Пример ответа                  |
|-----|-------------------------|--------------------------------|
| 200 | OK                      | { "result": "ok" }            |
| 400 | Неверные параметры      | { "error": "Bad request" }     |
| 401 | Нет/неверный/просроченный токен | { "error": "Unauthorized" }    |
| 404 | Ключ/БД не найдены      | { "error": "Not found" }       |
| 413 | Превышен лимит          | { "error": "Limit exceeded" }  |
| 500 | Внутренняя ошибка       | { "error": "Internal error" }  |

---

## Лимиты и ограничения

- Для каждой БД можно задать лимит размера (limit в байтах)
- Поведение при превышении лимита определяется параметром `limit_action` (см. выше)
- Ключи и значения — строки (максимальный размер ключа/значения: см. параметры компиляции или документацию)
- Максимальное количество ключей ограничено размером индексного файла
- При ротации (`limit_action=rotate`) автоматически удаляются только самые старые записи, база не очищается полностью, архивирование не предусмотрено

---

## Логирование

- Информационные сообщения — stdout
- Ошибки — stderr
- Формат: `[YYYY-MM-DD HH:MM:SS] [INFO/ERROR] сообщение`

---

## Запуск

```bash
./PKeyDB pkeydb.ini
```
- Если путь к конфигу не указан — используется pkeydb.ini в текущем каталоге
- При ошибке загрузки конфига — сообщение в stderr, завершение с кодом 1

---

## FAQ

**Q:** Почему не удаётся авторизоваться, даже если пароль верный?
**A:** В конфиге должен быть SHA256-хэш пароля, а не сам пароль. Проверьте, что хэш совпадает с тем, что выдаёт команда выше, и что он в нижнем регистре, без пробелов.

**Q:** Как сменить пароль для БД?
**A:** Получите новый SHA256-хэш нужной строки и замените значение `password` в конфиге, затем перезапустите сервер.

**Q:** Как добавить новую БД?
**A:** Добавьте параметры dbN.path, dbN.password, dbN.limit, dbN.limit_action в секцию [databases], **файлы базы будут созданы автоматически при первом обращении**, перезапустите сервер.

**Q:** Как восстановить данные после сбоя?
**A:** Используйте резервные копии файлов .idx и .dat. При повреждении индекса возможна потеря части данных.

**Q:** Как изменить порт?
**A:** Измените port в секции [server] конфига, перезапустите сервер.

**Q:** Что происходит при превышении лимита?
**A:** Если limit_action=error — запись блокируется, возвращается ошибка 413. Если limit_action=rotate — при попытке записи сверх лимита автоматически удаляются самые старые записи, пока размер базы не станет меньше лимита, затем новая запись добавляется. Если освободить место невозможно, возвращается ошибка 413.

**Q:** Можно ли отменить очистку базы?
**A:** Нет, операция очистки базы необратима.

---

## Примеры запросов

### Получение токена
```bash
curl -X POST http://localhost:8080/auth -H 'Content-Type: application/json' -d '{"dbname":"db1","password":"mypassword"}'
```

### Запись значения
```bash
curl -X POST http://localhost:8080/db/db1/set -H 'X-Auth-Token: <jwt>' -H 'Content-Type: application/json' -d '{"key":"foo","value":"bar"}'
```

### Получение значения
```bash
curl -X GET 'http://localhost:8080/db/db1/get?key=foo' -H 'X-Auth-Token: <jwt>'
```

### Удаление ключа
```bash
curl -X DELETE 'http://localhost:8080/db/db1/del?key=foo' -H 'X-Auth-Token: <jwt>'
```

### Очистка базы
```bash
curl -X POST http://localhost:8080/db/db1/clear -H 'X-Auth-Token: <jwt>'
```

---

## Структура проекта

- main.pas
- config.pas
- server.pas
- auth.pas
- storage.pas
- test_config.pas
- docs/api.md (эта документация)
- pkeydb.ini (пример конфига)
- data/ (каталог с файлами БД)

---

## Обратная связь

Вопросы и предложения — через issues в репозитории или по контактам разработчика. 