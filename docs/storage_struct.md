# Структура хранения PKeyDB (Extendible Hashing)

## 1. Директория (Directory)
- **global_depth: Byte** — глобальная глубина (сколько бит хеша используется для индексации директории)
- **bucket_offsets: array of QWord** — массив смещений бакетов в файле (размер = 2^global_depth)

## 2. Бакет (Bucket)
- **local_depth: Byte** — локальная глубина бакета
- **num_records: Word** — количество записей в бакете
- **records: array of BucketRecord** — массив записей (см. ниже)

## 3. Запись в бакете (BucketRecord)
- **key_hash: QWord** — хеш ключа (для быстрого сравнения)
- **key_size: Word** — длина ключа
- **key_data: array of Byte** — сам ключ (максимум 128 байт)
- **data_offset: QWord** — смещение значения в .dat
- **data_size: DWord** — размер значения
- **deleted: Byte** — флаг удаления (0/1)

## 4. Формат индексного файла (.idx)
```
[Header]
  global_depth: 1 байт
  num_buckets: 4 байта
  bucket_offsets: массив QWord (2^global_depth элементов)

[Bucket 0]
  local_depth: 1 байт
  num_records: 2 байта
  records: массив записей

[Bucket 1]
  ...
...
```

## 5. Формат файла данных (.dat)
- Последовательность блоков:
  - `[data_size: DWord][valid: Byte][data: ...]`
- Смещение на значение хранится в data_offset записи бакета.

## 6. Алгоритмы
- **Вставка:**
  1. Вычислить хеш ключа, взять global_depth младших бит — получить индекс директории.
  2. Перейти по offset'у к бакету, найти/добавить запись.
  3. Если бакет переполнен — split: создать новый бакет, увеличить local_depth, перераспределить записи, обновить директорию. Если нужно — удвоить директорию (global_depth++).
- **Удаление:**
  - Пометить запись как удалённую (deleted=1).
- **Поиск:**
  - Аналогично вставке, но только поиск по ключу.
- **Дефрагментация:**
  - Периодически пересоздавать .dat и обновлять data_offset в индексах.

## 7. Atomicity
- Все изменения (split, grow, insert) — сначала запись новых бакетов, потом обновление директории, потом fsync.
- Для crash-safety можно использовать временные файлы или журналирование (на перспективу).

## 8. Ограничения и параметры
- Максимальная длина ключа — 128 байт.
- Размер бакета — 4-16 КБ (подбирается экспериментально).
- Количество записей в бакете — зависит от размера бакета и записи. 