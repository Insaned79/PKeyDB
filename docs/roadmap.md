# Roadmap:PKeyDB Легковесная сетевая СУБД (ключ-значение) на Pascal (fpc)

## 1. Архитектура и компоненты

- **Серверный процесс**: единый исполняемый файл, запускается с параметром — путь к конфигу.
- **REST API**: взаимодействие с клиентом, CRUD-операции, авторизация.
- **Конфигурационный файл**: хранит параметры сервера, список БД и лимиты.
- **Файловое хранилище**: каждая БД — отдельный файл/каталог на диске.
- **Система авторизации**: пароли, токены, разграничение доступа.
- **Логирование**: stdout для информационных сообщений, stderr для ошибок.

## 2. Взаимодействие компонентов

- При запуске сервер читает конфиг, инициализирует логирование, открывает файловые БД.
- REST API принимает запросы, проверяет авторизацию, выполняет операции с данными.
- Все изменения данных сразу пишутся на диск.
- Логирование ведётся согласно настройкам.

## 3. Формат хранения данных

- **Структура**: два файла на каждую БД:
  - `{dbname}.idx` — индексный файл (директория + бакеты, динамически расширяется)
  - `{dbname}.dat` — файл с данными

- **Индексный файл (extendible hashing)**:
  - Содержит директорию (массив указателей на бакеты) и сами бакеты
  - Директория может удваиваться по мере необходимости (глобальная глубина)
  - Каждый бакет знает свою локальную глубину
  - При переполнении бакета происходит сплит: создаётся новый бакет, часть ключей переносится, директория обновляется
  - Если локальная глубина бакета равна глобальной — директория удваивается
  - Количество ключей не ограничено (кроме размера диска)
  - Все операции (insert, get, delete) требуют только чтения/записи нужного бакета и, иногда, модификации директории
  - Для atomicity: сначала пишется новый бакет, затем обновляется директория, затем fsync
  - Индекс может быть memory-mapped для ускорения доступа

- **Файл данных**:
  - Последовательное хранение значений
  - Каждое значение предваряется размером и флагом валидности
  - Использует memory-mapped files для эффективного доступа

- **Оптимизации**:
  - Кэширование часто используемых значений (опционально)
  - Периодическая дефрагментация файла данных
  - Компактификация при удалении записей
  - Для ротации (limit_action=rotate) — удаляются самые старые записи (по порядку в .dat или с помощью timestamp)

## 4. Конфигурационный файл

- **Формат**: INI 
- **Секции**:
  - `[server]` — адрес, порт, jwt_secret, jwt_expiry.
  - `[databases]` — список БД, для каждой: путь, пароль (**SHA256-хэш!**), лимит.
- **Пример (INI)**:
  ```
  [server]
  address=0.0.0.0
  port=8080
  jwt_secret=supersecretkey
  jwt_expiry=60

  [databases]
  db1.path=data/db1.db
  db1.password=5b11618c2e44027877d0cd0921ed166b9f176f50587fc91e7534dd2946db77d6  # SHA256("secret1")
  db1.limit=10485760
  db1.limit_action=rotate
  db2.path=data/db2.db
  db2.password=... # SHA256("secret2")
  db2.limit=none
  ```
- **ВАЖНО:** Пароль в конфиге — это SHA256-хэш строки-пароля (hex, нижний регистр). Не указывайте plain-текст!
- **Как получить SHA256-хэш:**
  - В Linux/macOS: `echo -n "yourpassword" | sha256sum`
  - В Windows: используйте openssl или онлайн-генератор.

## 5. REST API

- **Эндпоинты**:
  - `POST /auth` — авторизация, получение JWT-токена (HS256, срок жизни 60 минут).
  - `POST /db/{dbname}/set` — создать/обновить ключ (требует JWT).
  - `GET /db/{dbname}/get?key=...` — получить значение (требует JWT).
  - `DELETE /db/{dbname}/del?key=...` — удалить ключ (требует JWT).
  - `GET /db/{dbname}/list` — список ключей (требует JWT, опционально).
- **Авторизация**: JWT (HS256, claim sub=имя БД, exp=60 минут, iss=PKeyDB, jti).
- **Ошибки**: коды HTTP, сообщения в JSON (401 — если токен невалиден или истёк).
- **Примеры запросов/ответов**: включить в документацию.

## 6. Авторизация

- **Пароли**: хранятся в конфиге в виде SHA256-хэшей (hex, нижний регистр).
- **Проверка**: сервер сравнивает SHA256(введённого пароля) с хэшем из конфига.
- **JWT**: выдаётся при успешной авторизации, срок жизни — 60 минут (jwt_expiry).
- **Секрет**: хранится в конфиге (`jwt_secret` в секции [server]).
- **Claims**: sub (имя БД), iss (PKeyDB), exp, iat, jti.
- **Разграничение доступа**: токен привязан к конкретной БД (sub).
- **State токенов не хранится**: revoke — только сменой секрета.

## 7. Файловое хранилище

- **Структура**: отдельный файл на каждую БД.
- **Формат**: построчно, либо сериализованный JSON.
- **Лимиты**: при достижении лимита — ошибка при попытке записи.
- **Целостность**: атомарная запись, резервное копирование (опционально).

## 8. Запуск и конфигурирование

- **Параметры запуска**: путь к конфигу, если не указан — искать в текущем каталоге.
- **Обработка ошибок**: отсутствие конфига, ошибки чтения/записи, неверные параметры.
- **Логирование**: stdout для информационных сообщений, stderr для ошибок.

---

## Итоговая структура проекта

- `main.pas` — точка входа, обработка параметров, запуск сервера.
- `config.pas` — парсер конфигурационного файла.
- `server.pas` — HTTP сервер, обработка REST API.
- `auth.pas` — авторизация, работа с токенами.
- `storage.pas` — файловое хранилище, операции с БД.

---

