# Roadmap:PKeyDB Легковесная сетевая СУБД (ключ-значение) на Pascal (fpc)

## 1. Архитектура и компоненты

- **Серверный процесс**: единый исполняемый файл, запускается с параметром — путь к конфигу.
- **REST API**: взаимодействие с клиентом, CRUD-операции, авторизация.
- **Конфигурационный файл**: хранит параметры сервера, список БД и лимиты.
- **Файловое хранилище**: каждая БД — отдельный файл/каталог на диске.
- **Система авторизации**: пароли, токены, разграничение доступа.
- **Логирование**: stdout для информационных сообщений, stderr для ошибок.

## 2. Взаимодействие компонентов

- При запуске сервер читает конфиг, инициализирует логирование, открывает файловые БД.
- REST API принимает запросы, проверяет авторизацию, выполняет операции с данными.
- Все изменения данных сразу пишутся на диск.
- Логирование ведётся согласно настройкам.

## 3. Формат хранения данных

- **Структура**: два файла на каждую БД:
  - `{dbname}.idx` - индексный файл
  - `{dbname}.dat` - файл с данными

- **Индексный файл**:
  - Хеш-таблица с фиксированным размером блока
  - Запись содержит: хеш ключа, смещение в файле данных, размер значения, флаг удаления
  - Хранится в памяти для быстрого доступа

- **Файл данных**:
  - Последовательное хранение значений
  - Каждое значение предваряется размером и флагом валидности
  - Использует memory-mapped files для эффективного доступа

- **Оптимизации**:
  - Кэширование часто используемых значений
  - Периодическая дефрагментация файла данных
  - Компактификация при удалении записей

## 4. Конфигурационный файл

- **Формат**: INI 
- **Секции**:
  - `[server]` — адрес, порт.
  - `[databases]` — список БД, для каждой: путь, пароль, лимит.
- **Пример (INI)**:
  ```
  [server]
  address=0.0.0.0
  port=8080

  [databases]
  db1.path=data/db1.db
  db1.password=hash1
  db1.limit=10485760
  db2.path=data/db2.db
  db2.password=hash2
  db2.limit=none
  ```

## 5. REST API

- **Эндпоинты**:
  - `POST /auth` — авторизация, получение токена.
  - `POST /db/{dbname}/set` — создать/обновить ключ.
  - `GET /db/{dbname}/get?key=...` — получить значение.
  - `DELETE /db/{dbname}/del?key=...` — удалить ключ.
  - `GET /db/{dbname}/list` — список ключей (опционально).
- **Авторизация**: JWT или простой токен в заголовке.
- **Ошибки**: коды HTTP, сообщения в JSON.
- **Примеры запросов/ответов**: включить в документацию.

## 6. Авторизация

- **Пароли**: хранятся в конфиге в виде хэшей (например, SHA256).
- **Токены**: выдаются при успешной авторизации, срок жизни — опционально.
- **Проверка токена**: для каждого запроса к БД.
- **Разграничение доступа**: токен привязан к конкретной БД.

## 7. Файловое хранилище

- **Структура**: отдельный файл на каждую БД.
- **Формат**: построчно, либо сериализованный JSON.
- **Лимиты**: при достижении лимита — ошибка при попытке записи.
- **Целостность**: атомарная запись, резервное копирование (опционально).

## 8. Запуск и конфигурирование

- **Параметры запуска**: путь к конфигу, если не указан — искать в текущем каталоге.
- **Обработка ошибок**: отсутствие конфига, ошибки чтения/записи, неверные параметры.
- **Логирование**: stdout для информационных сообщений, stderr для ошибок.

---

## Итоговая структура проекта

- `main.pas` — точка входа, обработка параметров, запуск сервера.
- `config.pas` — парсер конфигурационного файла.
- `server.pas` — HTTP сервер, обработка REST API.
- `auth.pas` — авторизация, работа с токенами.
- `storage.pas` — файловое хранилище, операции с БД.

---

Этот роадмап можно использовать как основу для поэтапной реализации проекта. Если нужно — могу расписать каждый этап подробнее или предложить пример структуры кода. 